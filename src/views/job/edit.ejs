<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Chỉnh sửa thông tin công việc</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
        <style>
            .back-button-container {
                position: absolute;
                top: 10px; /* Điều chỉnh để di chuyển nút xuống */
                left: 10px; /* Điều chỉnh để di chuyển nút sang phải */
                z-index: 1000; /* Đảm bảo nút nằm phía trên các phần tử khác */
            }
        
            .back-button-container .btn {
                padding: 8px 16px; /* Điều chỉnh kích thước nút */
                font-size: 14px; /* Kích thước chữ */
                background-color: aqua;
                color: black;
            }
        </style>
        <script src="/tinymce/tinymce.min.js" referrerpolicy="origin"></script>
    </head>
    <body>
        <div class="back-button-container">
            <a href="/company/profile" class="btn btn-secondary">Quay lại</a>
        </div>
        <div class="container mt-4">
            <h3 class="text-center mb-4">Chỉnh sửa thông tin công việc</h3>
            <form id="editForm" class="border p-4 rounded bg-light">
                <div class="mb-3">
                    <label for="title" class="form-label">Tên công việc</label>
                    <input type="text" class="form-control" id="title" name="title" value="<%= job.title %>" required />
                </div>

                <!-- Salary -->
                <div class="mb-3">
                    <label for="salary" class="form-label">Lương</label>
                    <input
                        type="text"
                        class="form-control"
                        id="salary"
                        name="salary"
                        value="<%= job.salary %>"
                        required
                    />
                </div>

                <!-- Salary Negotiation -->
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="salaryNegotiation" name="salary_negotiation" <%= job.salaryNegotiation ? 'checked' : '' %>>
                    <label for="salaryNegotiation" class="form-check-label">Lương thoả thuận</label>
                </div>

                <!-- Region -->
                <div class="mb-3">
                    <label for="jobRegion" class="form-label">Khu vực làm việc</label>
                    <select class="form-select" id="jobRegion" name="jobRegion" required>
                      <% provinces.forEach(province => { %>
                        <option value="<%= province.name %>" <%= province.name === job.region ? 'selected' : '' %> >
                          <%= province.name %>
                        </option>
                      <% }) %>
                    </select>
                  </div>

                <!-- Job Experience -->
                <div class="mb-3">
                    <label for="jobExperience" class="form-label">Kinh nghiệm làm việc (năm)</label>
                    <input
                        type="number"
                        class="form-control"
                        id="jobExperience"
                        name="experienceYears"
                        value="<%= job.experienceYears %>"
                        required
                    />
                </div>

                <!-- Last Date -->
                <div class="mb-3">
                    <label for="lastDate" class="form-label">Hạn cuối ứng tuyển</label>
                    <input
                        type="date"
                        class="form-control"
                        id="lastDate"
                        name="deadline"
                        value="<%= job.deadline.toISOString().split('T')[0] %>"
                        required
                    />
                </div>

                

                 <!-- Job Description -->
            <div class="mb-3">
                <label for="jobDescription" class="form-label">Mô tả công việc</label>
                <textarea class="form-control" id="jobDescription" name="job_description" >
<%- job.description %>
                </textarea>
            </div>

            <!-- Job Requirement -->
            <div class="mb-3">
                <label for="jobRequirement" class="form-label">Yêu cầu công việc</label>
                <textarea class="form-control" id="jobRequirement" name="job_requirement" >
<%- job.requirement %>
                </textarea>
            </div>

            <!-- Job Benefit -->
            <div class="mb-3">
                <label for="jobBenefit" class="form-label">Phúc lợi</label>
                <textarea class="form-control" id="jobBenefit" name="job_benefit" >
<%- job.benefit %>
                </textarea>
            </div>

                <!-- Location -->
                <div class="mb-3">
                    <label for="location" class="form-label">Địa điểm làm việc</label>
                    <input
                        type="text"
                        class="form-control"
                        id="location"
                        name="location"
                        value="<%= job.location %>"
                        required
                    />
                </div>

                <!-- Job Time -->
                <div class="mb-3">
                    <label for="jobTime" class="form-label">Thời gian làm việc</label>
                    <input
                        type="text"
                        class="form-control"
                        id="jobTime"
                        name="job_time"
                        value="<%= job.time %>"
                        required
                    />
                </div>

                <!-- Level -->
                <div class="mb-3">
                    <label for="level" class="form-label">Cấp độ</label>
                    <input type="text" class="form-control" id="level" name="level" value="<%= job.level %>" required />
                </div>

                <!-- Number of Recruitment -->
                <div class="mb-3">
                    <label for="numberOfRecruitment" class="form-label">Số lượng ứng tuyển</label>
                    <input
                        type="number"
                        class="form-control"
                        id="numberOfRecruitment"
                        name="numberOfRecruitment"
                        value="<%= job.number_of_recruitment %>"
                        required
                    />
                </div>

                <!-- Job Status -->
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="jobStatus" name="job_status" <%= job.status ? 'checked' : '' %>>
                    <label for="jobStatus" class="form-check-label">Công việc còn tuyển</label>
                </div>

                <!-- Type of Work -->
                <div class="mb-3">
                    <label for="typeOfWork" class="form-label">Loại hình làm việc</label>
                    <input
                        type="text"
                        class="form-control"
                        id="typeOfWork"
                        name="typeOfWork"
                        value="<%= job.typeOfWork %>"
                        required
                    />
                </div>
                <!-- Type of Work -->
                <div class="mb-3">
                    <label for="typeOfWork" class="form-label">Phương thức làm việc</label>
                    <input
                        type="text"
                        class="form-control"
                        id="type"
                        name="type"
                        value="<%= job.type %>"
                        required
                    />
                </div>

                <!-- Skills -->
                <div class="mb-3">
                    <label for="skills" class="form-label">Kỹ năng liên quan</label>
                    <input
                        type="text"
                        class="form-control"
                        id="skills"
                        name="skills"
                        value="<%= job.skills.join(', ') %>"
                        
                    />
                </div>

                <!-- Submit Button -->
                <button type="submit" class="btn btn-primary w-100">Lưu chỉnh sửa</button>

            </form>
            
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.19/dist/sweetalert2.min.js"></script>

        <script>
            // Khởi tạo TinyMCE
            tinymce.init({
                selector: '#jobDescription, #jobRequirement, #jobBenefit',
                plugins: 'lists link table image code',
                toolbar: 'undo redo | formatselect | bold italic | alignleft aligncenter alignright | bullist numlist outdent indent | link image code',
                height: 300,
            });
            document.getElementById('editForm').addEventListener('submit', async function (event) {
                event.preventDefault();

                Swal.fire({
                    title: "Đang thực hiện...",
                    html: "Vui lòng đợi trong giây lát...",
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading(); // Hiển thị vòng quay loading
                    },
                });
                // Lấy form element
                const form = document.getElementById('editForm');
        
                // Thu thập dữ liệu từ các trường trong form
                const formData = new FormData(form);
                const data = {};
                formData.forEach((value, key) => {
                    if (key === 'salary_negotiation' || key === 'job_status') {
                        data[key] = formData.get(key) ? true : false; // Chuyển đổi checkbox thành boolean
                    } else {
                        data[key] = value;
                    }
                });
        
                // Gửi dữ liệu qua API
                try {
                    const response = await fetch('/company/jobs/<%= job._id %>/update', {
                        method: 'POST', // Phương thức HTTP PUT
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data),
                    }).then (response => {
                        return response.json();
                    }).then(data => {
                        Swal.close();
                        if(data.success) {
                            Swal.fire({
                                icon: "success",
                                title: "Thành công!",
                                text: "Tạo công ty thành công!",
                                showConfirmButton: false,
                                timer: 1500,
                            }).then(() => {
                                window.location.href = "/company/jobs/<%= job._id %>/show";
                            });
                        } else {
                            Swal.fire({
                                icon: "error",
                                title: "Lỗi",
                                text: "Lỗi khi cập nhật thông tin!",
                                showConfirmButton: true,
                            });
                        }
                    })
                } catch (err) {
                    Swal.fire({
                        icon: "error",
                        title: "Lỗi",
                        text: "Lỗi khi cập nhật thông tin!",
                        showConfirmButton: true,
                    });
                }
            });
            
        </script>
    </body>
</html>
